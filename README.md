# 医疗问答大模型系统3.0

3.0版本基于LLM的医疗问答系统，重点优化**多轮对话效果**，新增分层记忆架构、增强型NLU和个性化交互系统，提供更智能、更人性化的医疗咨询体验。

## 功能特点
- 完整的问诊流程管理
- 智能紧急情况识别
- 基础信息系统性收集
- 症状分析和风险评估
- 分级转诊建议
- 健康教育知识普及
- 知识库检索增强
- **多轮对话优化**
- **分层记忆架构**（短期/中期/长期记忆）
- **增强型NLU系统**（实体识别、意图检测、上下文分析）
- **个性化交互系统**（基于用户画像的差异化交互）

## 3.0 核心升级亮点

    | 维度 | 2.0版本 | 3.0版本 |
    | ---- | ------- | ------- |
    | 上下文处理 | 单轮状态存储 | 分层记忆架构（短期/中期/长期记忆） |
    | 个性化 | 标准化建议 | 基于用户画像的差异化交互 |
    | 症状识别 | 描述症状实体提取 | 增强型描述性症状实体提取 |
    | 对话能力 | 固定流程问询 | 自动关联上下文生成交叉问询 |

## 系统结构
    medical_LLM_system/
    ├── src/
    │   ├── dialogue/           # 对话管理系统
    │   │   ├── manager.py      # 对话管理器 (3.0：集成短中长期记忆，NLU，个性化模块)
    │   │   ├── flows.py        # 对话流程实现
    │   │   ├── states.py       # 状态定义
    │   │   ├── utils.py        # 工具函数
    │   │   └── field_mappings.py  # 字段映射定义
    │   ├── knowledge/          # 知识库管理
    │   │   ├── kb.py           # 知识库实现
    │   │   ├── ragflow_kb.py   # RAGFlow知识库实现
    │   │   ├── factory.py      # 知识库工厂类
    │   │   └── vector_store.py # 向量存储实现
    │   ├── memory/             # 3.0：记忆系统
    │   │   ├── short_term.py   # 短期记忆
    │   │   ├── mid_term.py     # 中期记忆
    │   │   ├── long_term.py    # 长期记忆
    │   │   └── manager.py      # 记忆管理器
    │   ├── personalization/    # 3.0：个性化系统
    │   │   ├── user_profile.py        # 用户画像
    │   │   ├── preference_detector.py # 偏好检测器 
    │   │   ├── response_generator.py  # 响应生成器
    │   │   └── manager.py             # 个性化管理器
    │   ├── nlu/                # 3.0：自然语言理解模块
    │   │   ├── entity_recognition.py  # 实体识别
    │   │   ├── intent_detection.py    # 意图检测
    │   │   └── context_analyzer.py    # 上下文分析器
    │   ├── config/             # 配置管理
    │   │   ├── loader.py       # 配置加载器 
    │   │   ├── states.json     # 状态配置
    │   │   └── field_mappings.json # 字段映射配置
    │   ├── llm/                # LLM接口
    │   │   └── api.py          # API实现
    │   ├── prompts/            # 提示词配置
    │   │   └── medical_prompts.py
    │   ├── auth/               # 用户认证
    │   │   ├── user_manager.py  # 用户管理
    │   │   └── session_manager.py # 会话管理
    │   └── app_config.py       # 应用配置
    ├── data/
    │   ├── knowledge_base/     # 医疗知识源数据
    │   ├── vector_store/       # 向量数据
    │   └── profiles/           # 3.0：用户画像存储
    └── examples/
        ├── main.py             # 主程序示例
        └── test_llm_flow.py    # LLM流程测试
    

## 新增功能详解

### 1. 分层记忆架构
系统实现了三层记忆架构，使对话系统具备"记忆"能力：
- 短期记忆：存储当前会话的对话历史、提取的症状、临时诊断结果
- 中期记忆：保存近期就诊记录、处方历史，可在后续就诊中被检索和引用
- 长期记忆：存储患者档案和病史，使用向量数据库实现语义相似度检索
记忆管理器（MemoryManager）协调三层记忆之间的信息流转，支持主动检索和使用历史信息。

### 2. 增强型NLU组件
升级的NLU组件包含以下关键功能：

- 实体识别：提升症状描述识别准确率，支持复杂描述性文本分析
- 意图检测：识别用户交互意图（咨询、紧急求助、报告症状等）
- 上下文分析：分析消息与对话上下文的关系，检测信息矛盾
- 症状交叉引用：将新提及的症状与历史症状进行关联和比较

### 3. 个性化交互系统
全新的个性化系统包含多个组件：
- 用户画像：存储用户基本信息、医疗历史、症状记录和交互偏好
- 偏好检测：从对话中识别用户的沟通风格和信息详细程度偏好
- 个性化响应：根据用户偏好调整回复风格和内容
- 症状追踪：比较症状变化，提供针对性反馈（"您的头痛症状相比上次有所改善"）

## 系统逻辑
系统实现了完整的问诊流程状态机，流程图如下：

```mermaid
stateDiagram-v2
    [*] --> INITIAL: 开始对话
    
    INITIAL --> COLLECTING_COMBINED_INFO: 初始化对话
    
    COLLECTING_COMBINED_INFO --> REFERRAL: 检测到紧急情况
    note right of COLLECTING_COMBINED_INFO
        紧急情况判断规则:
        1. 症状严重程度 >= 8
        2. LLM识别危急症状关键词
    end note
    
    COLLECTING_COMBINED_INFO --> LIFE_STYLE: 信息收集完成
    
    LIFE_STYLE --> DIAGNOSIS: 完成生活习惯收集
    
    DIAGNOSIS --> MEDICAL_ADVICE: 症状严重程度 < 5
    DIAGNOSIS --> REFERRAL: 症状严重程度 >= 5
    note right of DIAGNOSIS
        分流依据：
        - <5: 提供医疗建议
        - >=5: 转诊就医
    end note
    
    MEDICAL_ADVICE --> EDUCATION
    REFERRAL --> EDUCATION
    
    EDUCATION --> ENDED
    ENDED --> [*]
```

系统各状态说明：

1. 初始状态(INITIAL)
   - 系统启动，准备开始对话
   - 自动转换到综合信息收集状态
   
2. 综合信息收集状态 (COLLECTING_COMBINED_INFO)
   - 智能化信息收集阶段，LLM动态引导收集信息的优先级顺序：

     1. 主要症状（最高优先级）
     2. 症状持续时间
     3. 症状严重程度
     4. 基本信息（年龄、性别）
     5. 额外症状细节

   - 特殊判断机制

     - 实时检测紧急情况 如症状严重程度 >= 8 或 LLM识别到危急症状，直接转入转诊流程

   信息收集完成后进入生活方式收集

3. 生活方式收集 (LIFE_STYLE)
   - 收集用户生活习惯信息：
     - 睡眠情况
     - 饮食习惯
     - 运动情况
     - 工作压力
     - 烟酒习惯

4. 诊断分析 (DIAGNOSIS)
   - 根据收集的信息进行初步诊断
   - 评估症状严重程度
   - 决定后续流程

   - 分流规则：症状严重程度 < 5：进入医疗建议流程， 症状严重程度 >= 5：进入转诊流程

5. 医疗建议 (MEDICAL_ADVICE)
   - 为轻症患者提供： 用药建议， 生活调整方案， 自我观察指导

6. 转诊建议 (REFERRAL)
   - 为需要及时就医的患者提供： 就医科室建议 ，就医等级 ，紧急程度说明 ，就医注意事项

7. 健康教育 (EDUCATION)
   - 相关疾病知识普及
   - 预防建议
   - 日常健康管理指导

8. 结束状态 (ENDED)

### 3.0版本新增功能处理流程

```mermaid
flowchart TD
    A[用户输入消息] --> B[对话管理器处理]
    B --> C[记忆系统更新]
    B --> D[NLU处理]
    D --> E[个性化管理器更新]
    
    E --> F{检测用户偏好}
    F -->|沟通风格| G[专业/友好/中性]
    F -->|信息详细程度| H[简洁/标准/详细]
    
    B --> I[生成基础响应]
    I --> J[个性化响应处理]
    
    G --> J
    H --> J
    
    C --> K[症状变化追踪]
    K --> J
    
    J --> L[返回个性化响应]
```
### 记忆系统架构
短期记忆存储格式（内存字典）：
```
{
  "current_dialogue": [
    {"role": "patient", "content": "我最近头痛", "timestamp": "2023-10-01 14:30:22"},
    {"role": "doctor", "content": "头痛持续多久了？", "timestamp": "2023-10-01 14:30:45"}
  ],
  "current_symptoms": [
    {"name": "头痛", "location": "额头", "severity": "中度", "first_mentioned": "2023-10-01 14:30:22"},
    {"name": "眩晕", "pattern": "起立时加重", "first_mentioned": "2023-10-01 14:32:10"}
  ],
  "temp_diagnosis": "可能是偏头痛",
  "entity_mentions": {
    "symptom": {
      "头痛": [{"context": "我最近头痛", "timestamp": "2023-10-01 14:30:22"}]
    }
  },
  "context_info": {
    "past_symptoms": ["发热", "咳嗽"],
    "past_diagnoses": ["上呼吸道感染"]
  }
}
```
中期记忆存储格式（Redis）：
```
KEY: medical_mid_term:patient:{patient_id}
VALUE: {"name": "张三", "age": "45", "gender": "男"}

KEY: medical_mid_term:consultation:{patient_id}:{consultation_id}
VALUE: {
  "timestamp": "2023-10-01 15:00:00",
  "dialogue": [...对话历史...],
  "symptoms": [...症状列表...],
  "diagnosis": "偏头痛"
}

KEY: medical_mid_term:consultation_index:{patient_id}
VALUE: SET ["consultation_20231001_123", "consultation_20231005_456"]

KEY: medical_mid_term:prescription:{patient_id}:{prescription_id}
VALUE: {
  "timestamp": "2023-10-01 15:30:00",
  "medication": "布洛芬",
  "dosage": "400mg",
  "frequency": "每8小时一次",
  "duration": "3天"
}
```
长期记忆存储格式（Ragflow chunk）：
```
{
  "id": "profile_{patient_id}",
  "text": "{\"name\":\"张三\",\"age\":\"45\",\"gender\":\"男\",\"allergies\":[\"青霉素\"]}",
  "metadata": {
    "patient_id": "patient_001",
    "type": "profile",
    "timestamp": "2023-09-30T10:15:30"
  },
  "embedding": [0.1, 0.2, 0.3, ...]
}

{
  "id": "history_{patient_id}_{timestamp}",
  "text": "{\"symptoms\":[\"头痛\",\"眩晕\"],\"diagnosis\":\"偏头痛\",\"notes\":\"长期反复发作\"}",
  "metadata": {
    "patient_id": "patient_001",
    "type": "medical_history",
    "timestamp": "2023-10-01T15:00:00"
  },
  "embedding": [0.4, 0.5, 0.6, ...]
}
```
用户画像储存格式（Json 文件）：
```
{
  "user_id": "patient_001",
  "basic_info": {
    "name": "张三",
    "age": "45",
    "gender": "男",
    "occupation": "软件工程师"
  },
  "medical_history": {
    "diseases": ["高血压", "胆囊炎"],
    "allergies": ["青霉素", "海鲜"],
    "surgeries": ["胆囊切除术(2018年)"]
  },
  "symptom_entities": {
    "头痛": {
      "location": "额头",
      "pattern": "间歇性",
      "severity": "中度",
      "duration": "反复发作3年",
      "first_mentioned": "2023-10-01 14:30:22"
    },
    "眩晕": {
      "severity": "轻度",
      "pattern": "起立时加重",
      "duration": "近1个月",
      "first_mentioned": "2023-10-01 14:32:10"
    }
  },
  "preferences": {
    "communication_style": "professional",
    "detail_level": "detailed"
  },
  "last_update": "2023-10-01 15:45:30"
}
```
## 安装依赖
    pip install -r requirements.txt

主要依赖：
- deepseek R1 #LLM api接口
- faiss-cpu/ Ragflow #向量数据存储
- sentence-transformers/ BGE #embedding模型
- langchain / Ragflow #知识库管理
- pandas #数据处理

## 使用方法
```python
from examples.main import init_system

def main(use_ragflow=False):
    # 初始化系统，可选是否使用RAGFlow知识库
    manager = init_system(use_ragflow=use_ragflow)
    
    # 可以通过set_use_llm_flow控制是否使用LLM驱动的流程
    manager.set_use_llm_flow(True)  # 默认开启
    
    print("医疗助手: 您好,我是您的医疗助手。有什么可以帮您？")
    
    # 多轮对话
    while True:
        user_input = input("患者: ").strip()
        if user_input.lower() in ['退出', 'quit', 'exit']:
            break
            
        response = manager.process_message(user_input)
        print(f"医疗助手: {response}")
        
        # 对话结束检查
        if manager.context.state.value == 'ended':
            print("\n对话结束,感谢您的使用\n")
            break

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(description='医疗问答系统')
    parser.add_argument('--ragflow', action='store_true', help='使用RAGFlow知识库')
    args = parser.parse_args()
    
    main(use_ragflow=args.ragflow)
```

## 数据集
采用多源医疗数据：
1. 基础问答数据
   - 来源：开源中文医疗问答数据集
   - 数量：28000 条QA问答
2. 医学教材知识 （23 本中文教材）
3. 多轮问答语料 (Claude  Sonnet 3.7生成120条多轮问答)

基础问答数据格式示例：

    | department	| title | question | answer |
    |------------|-------|-----------|---------|
    | 内科 | 头痛症状 | 我最近经常头痛，该怎么办？ | 建议您首先记录头痛的具体表现... |

多轮问答示例
```
科室标签
耳鼻喉科
关键词
慢性鼻炎、慢性鼻窦炎、鼻塞、鼻涕、头痛、感染、鼻腔冲洗、抗生素、鼻内窥镜手术、鼻息肉
检索问题

慢性鼻炎和慢性鼻窦炎有什么区别？
慢性鼻炎需要手术治疗吗？
慢性鼻炎反复发作的原因是什么？
鼻腔冲洗对慢性鼻炎有效吗？
长期使用鼻腔喷雾剂安全吗？
慢性鼻炎会引起其他并发症吗？


初诊（耳鼻喉科门诊）
医生：李先生，您好，我是张医生。请问您有什么不舒服？
患者（45岁，男性）：（声音有些鼻音）医生，我这鼻子堵得厉害，有好几年了。鼻涕又黄又浓，有时候还带血丝。早上起来第一件事就是使劲擤鼻涕，不弄出来就难受。最近还经常头疼，特别是眉心和鼻根这一带。
医生：您这些症状持续多久了？有没有什么因素会让症状加重，比如季节变化或者感冒后？
患者：断断续续有五六年了吧。一开始以为就是普通感冒，吃点药就好了，但老是反复。每次感冒后症状就会加重，好不容易才能缓解一点，但从来没完全好过。对了，冬天好像会严重一些。（突然问道）医生，我这是不是鼻窦炎啊？我在网上查了症状，挺像的。
医生：从您描述的症状来看，确实符合慢性鼻窦炎的表现。慢性鼻窦炎是指鼻窦黏膜的长期炎症，常表现为鼻塞、浓涕、面部疼痛或压迫感等症状。慢性鼻炎和慢性鼻窦炎常常同时存在，因为鼻腔和鼻窦是相连的。您平时还有其他症状吗，比如嗅觉减退或者咳嗽，尤其是晚上躺下后的咳嗽？
患者：（思考片刻）嗯，好像是有点闻不太到味道，但不是特别明显。咳嗽倒是有，尤其是早上起来，感觉有痰从鼻子后面往下流，咳出来的痰和鼻涕差不多。（转向其他话题）医生，我前年看过一次，那个医生说是鼻甲肥大，让我做个手术。但我一听说手术就害怕，所以一直没去。这次非得做手术吗？
医生：不一定需要手术，这要根据您的具体情况来决定。后鼻滴流感和晨起咳嗽也是慢性鼻窦炎的常见表现。我需要检查一下您的鼻腔情况。关于您提到的鼻甲肥大，这是慢性鼻炎的一种表现，肥大的鼻甲会导致鼻腔通道变窄，引起鼻塞。治疗方式包括药物治疗和手术治疗，要根据严重程度和对生活的影响来选择。
（医生进行鼻内窥镜检查）
医生：检查结果显示您的鼻黏膜充血肿胀，中鼻甲有肥大，鼻道有黄色浓性分泌物，特别是在中鼻道，这提示可能存在鼻窦引流障碍。我建议做个鼻窦CT检查，以便更清楚地了解鼻窦的情况和病变程度。
患者：（有些担忧）CT检查有辐射吧？会不会对身体有害？（不等医生回答）对了，医生，我这个病是不是因为我经常憋着不擤鼻涕引起的？我工作忙，有时候会憋很久。
医生：CT检查的辐射量很小，一次检查对健康的影响可以忽略不计，无需太担心。关于您的问题，慢性鼻窦炎通常不是因为憋着不擤鼻涕引起的，而是由于多种因素综合作用的结果，包括细菌或病毒感染、鼻腔解剖结构异常（如鼻中隔偏曲）、鼻腔息肉、过敏等。频繁的上呼吸道感染、长期接触刺激物（如烟草烟雾）、免疫力低下等也是危险因素。
患者：（点头）明白了。（转换话题）医生，我朋友推荐我用高锰酸钾溶液洗鼻子，说效果很好，这靠谱吗？
医生：高锰酸钾有一定消毒作用，但不推荐用于鼻腔冲洗，因为浓度不当可能刺激甚至损伤鼻黏膜。对于鼻腔冲洗，建议使用生理盐水或专门的鼻腔冲洗液。鼻腔冲洗确实对慢性鼻窦炎有帮助，可以清除鼻腔内的分泌物和刺激物，但方法一定要正确，使用合适的溶液。如果您有兴趣，我可以教您正确的冲洗方法。
患者：好的，我想学习一下。对了，我现在需要吃抗生素吗？每次感冒我都会自己买些抗生素吃，一般阿莫西林，但效果不太明显。
医生：慢性鼻窦炎不一定每次都需要抗生素，除非有明确的细菌感染证据，如发热或脓性分泌物明显增多。过度使用抗生素可能导致耐药性，反而不利于疾病控制。对于慢性鼻窦炎，更重要的是控制炎症、改善鼻窦引流和处理潜在因素。我们先做CT检查评估病情，然后制定个性化的治疗方案，可能包括鼻腔冲洗、鼻用糖皮质激素喷雾、必要时的短程抗生素等。
患者：（有些困惑）不用抗生素怎么治感染呢？我一直以为是鼻子里有细菌，所以才会有黄鼻涕。
医生：您的理解很常见，但实际上慢性鼻窦炎是一个复杂的炎症过程，不仅仅是简单的细菌感染。黄色或绿色鼻涕确实可能提示感染，但也可能是慢性炎症的表现。关键是改善鼻窦通气和引流，减轻黏膜炎症。鼻腔冲洗可以物理性地清除分泌物，鼻用激素可以减轻炎症和黏膜水肿，这些都是基础治疗。抗生素只在特定情况下使用，比如急性发作或明确的细菌感染征象。
患者：原来如此。（想了想）医生，那我这种情况严重吗？会不会引起其他问题？
医生：慢性鼻窦炎如果不及时处理，可能会影响生活质量，导致睡眠障碍、嗅觉减退、慢性疲劳等问题。在少数情况下，严重的慢性鼻窦炎可能引起并发症，如鼻息肉、中耳炎或极少见的颅内并发症。从您的症状描述看，属于中度慢性鼻窦炎，及时规范治疗后，大多数症状都能得到明显改善。不过我们还是需要通过CT检查来确定炎症的具体范围和严重程度。
患者：（松了口气）那就做个CT吧。（突然想起）对了，医生，我经常用一种通鼻喷雾，喷了就能通气，感觉特别舒服。可以一直用吗？
医生：您说的可能是血管收缩剂类鼻喷剂，如羟甲唑啉或赛洛唑啉。这类药物确实能快速缓解鼻塞，但不建议连续使用超过5-7天。长期使用会导致药物性鼻炎，出现"反跳性"鼻塞，就是停药后鼻塞会比以前更严重，形成恶性循环。如果您已经长期使用，需要在医生指导下逐渐停用，可能要结合鼻用激素喷雾来减轻症状。
患者：（惊讶）真的吗？我已经用了好几个月了，难怪感觉越来越离不开它。（转向另一话题）医生，我还听说吃一些辛辣食物可以通鼻子，是这样吗？
医生：辛辣食物确实可能暂时缓解鼻塞，因为它们可以刺激鼻腔分泌，但这只是短暂效果，不能解决根本问题。对于某些人，特别是本身就有胃食管反流的患者，辛辣食物反而可能加重鼻炎症状。均衡饮食、避免过度刺激性食物，对身体整体健康更有利。
患者：明白了。那我现在主要是做CT检查，然后呢？
医生：是的，先做CT检查，然后根据结果制定具体治疗方案。初步来说，我建议您开始使用鼻腔冲洗，每天至少两次，加上鼻用糖皮质激素喷雾来减轻炎症。对于您目前使用的血管收缩剂鼻喷剂，需要逐渐减量直至停用。如果CT显示严重的鼻窦炎或解剖异常，可能需要考虑抗生素治疗或评估手术必要性。
患者：好的，我去做CT。对了，能不能开点中药调理？我姐夫吃过一种叫"鼻渊通窍冲剂"的，说效果不错。
医生：一些中药制剂确实可能对慢性鼻炎、鼻窦炎有一定辅助作用。"鼻渊通窍冲剂"这类中成药有一定清热通窍的功效，可以作为辅助治疗，但不建议完全替代现代医学治疗方法。如果您有兴趣，可以在中医科就诊，获得更个性化的中医治疗建议。今天我们先专注于解决炎症和鼻塞问题，后续可以考虑中西医结合的治疗方式。
患者：好的，那我先去做CT。这个要预约吗？
医生：鼻窦CT通常不需要特别预约，我给您开检查单，您可以直接去放射科检查。检查完后带着结果回来，我们再详细讨论治疗方案。
患者：好的，谢谢医生。

复诊（一周后）
医生：李先生，您好。我看了您的CT结果，显示您的上颌窦、筛窦和额窦都有黏膜增厚，特别是上颌窦较为明显，有积液阴影。左侧鼻道有中度鼻甲肥大，右侧还有轻度鼻中隔偏曲。这些发现支持慢性鼻窦炎的诊断，也解释了您为什么会有持续的鼻塞和头痛。
患者：（担忧地）听起来挺严重的。这需要手术吗？
医生：不一定需要立即手术。我们可以先尝试药物治疗和鼻腔冲洗，很多患者能够通过这些方法获得明显改善。手术通常考虑在药物治疗效果不佳或者有明确解剖异常影响鼻窦引流的情况下。从您的CT来看，虽然有鼻中隔偏曲，但程度不是很严重。我建议先进行规范的药物治疗，观察2-3个月。
患者：太好了，我真的不想做手术。（转换话题）对了医生，我按您说的用了生理盐水冲洗鼻子，感觉确实好了一些，但总觉得盐水要流到喉咙里，味道怪怪的，正常吗？
医生：鼻腔冲洗时有少量溶液流到喉咙是正常的，因为鼻腔后方与咽喉相通。关键是掌握正确的姿势和力度，头部稍微前倾，嘴巴张开呼吸，让水从另一侧鼻孔自然流出。如果大量液体进入喉咙，可能是姿势不够正确。您可以调整一下角度，或者减少一次冲洗的液体量。
患者：我试试看。（突然问道）医生，我用了您上次推荐的鼻喷激素，但感觉没什么立竿见影的效果，还要继续用吗？
医生：鼻用糖皮质激素需要坚持使用一段时间才能看到明显效果，通常至少需要1-2周，完全发挥作用可能需要2-4周。不像血管收缩剂那样能快速缓解鼻塞，它主要是通过减轻黏膜炎症来逐渐改善症状。所以请您坚持使用，效果会逐渐显现。正确的使用方法也很重要：喷前轻轻擤鼻子清除分泌物，喷时头部略微前倾，喷嘴指向外侧而非鼻中隔，喷后不要立即擤鼻子。
患者：好的，我继续用。（犹豫了一下）那个...医生，我自己在网上买了一种抗生素，阿奇霉素，吃了三天，感觉黄鼻涕少了一些，我要不要继续吃完？
医生：我不建议自行使用抗生素。阿奇霉素是一种强效抗生素，不适合未经医生评估就使用。过度或不当使用抗生素可能导致耐药性，长期来看反而不利于疾病控制。既然您已经服用了一部分，观察到一些改善，可以在完成这个疗程后停止，但以后请不要自行使用抗生素。根据您的CT结果和症状，我今天会给您开一个短程的抗生素治疗，配合鼻腔冲洗和鼻用激素，这样的综合治疗更有效。
患者：明白了，以后不会自己乱吃药了。（想了想）医生，有没有什么食物要特别注意的？我老婆说牛奶会生痰，让我少喝。
医生：关于牛奶增加痰液的说法，科学证据并不充分。除非您确定对牛奶过敏或不耐受，否则没必要特意避免。饮食上没有严格的限制，但建议均衡饮食，保证充足的蔬果摄入，适当补充维生素D和锌等营养素有助于免疫功能。如果发现某些食物确实会加重症状，可以相应减少摄入。另外，保持充分水分摄入有助于稀释分泌物。
患者：这样啊。（转向其他问题）对了，我现在经常头疼，特别是额头和眼睛周围，是因为鼻窦炎吗？
医生：是的，您描述的头痛位置很典型，正是额窦和筛窦炎症引起的。鼻窦炎可引起相应区域的胀痛、压迫感或钝痛，常在弯腰或躺下时加重。随着鼻窦炎的改善，这些头痛通常会减轻。如果疼痛明显影响生活，可以适当使用非处方止痛药如布洛芬或对乙酰氨基酚缓解症状，但长期解决方案是治疗根本的鼻窦炎。
患者：原来如此。（叹气）这病能完全治好吗？我都好几年了。
医生：慢性鼻窦炎的"完全治愈"确实有挑战性，尤其是已经持续多年的情况。但通过规范治疗，绝大多数患者能获得症状的显著改善和良好控制。关键是找到适合您的综合治疗方案，并解决可能的诱因。有些患者在积极治疗一段时间后，可以维持长期缓解；有些可能需要间歇性治疗来控制反复发作；还有一部分患者在药物治疗效果有限时，可能从手术中获益。我们会根据您的治疗反应逐步调整方案。
患者：（点头）好的，我理解了。那今天开哪些药物？怎么吃？
医生：我给您开以下药物：一是莫米松鼻喷剂，每侧鼻腔每天两喷，坚持使用至少4周；二是盐酸左氧氟沙星片，一天一次，连续两周，这是抗生素，帮助控制感染；三是鼻腔冲洗液，每天两次，坚持使用。此外，您可以在头痛明显时适当使用布洛芬缓解症状。这些治疗方法结合使用，效果会更好。
患者：好的，我记住了。两周后要复查吗？
医生：对，建议两周后复诊，评估抗生素疗程结束后的情况。但即使症状改善，也请继续使用鼻喷剂和鼻腔冲洗至少4周。如果期间症状加重，比如发热、剧烈头痛或眼部肿胀，请立即就医。另外，保持良好的生活习惯也很重要：保证充足睡眠，避免烟草烟雾，减少酒精摄入，适当运动增强免疫力。
患者：好的，我都明白了。最后一个问题，这个病会传染吗？我担心传给家人。
医生：慢性鼻窦炎本身不具传染性，不会像感冒病毒那样人传人。它是一种炎症状态，可能由多种因素引起，包括解剖结构、免疫反应、微生物定植等。当然，如果有急性感染加重，理论上感染性病原体可能传播，但这与普通上呼吸道感染相同，保持基本卫生习惯即可，不需要特殊隔离措施。
患者：那就好，谢谢医生，我按您说的治疗。
医生：不客气。记得坚持使用药物，两周后复诊。如果有任何问题，随时可以来咨询。祝您早日康复！
患者：谢谢，再见！
```
本版本完成了与RAGFlow知识检索服务的集成，相较于2.0版本的本地知识库，提供了更优的医疗领域检索和问答能力。

### RAGFlow技术参数

- 医学元数据标注：针对医学教材进行了专业的元数据标注，针对多轮问答进行了科室，关键词以及检索问题标签，支持基于科室、疾病类型等多维度的精准检索
- 分层医学知识索引：实现了从医学概念到具体临床案例的分层知识索引架构，更符合医学知识组织特点
- 语义分块：采用BGE嵌入模型进行医学文本的语义表示，保证了医学概念的完整性和连贯性
- 重排序模型：利用Gte@qainwen 重排序模型对检索结果进行精细排序，大幅提升检索精度
- 混合检索策略：结合向量相似度和重排序评分的混合检索策略，通过相似度阈值过滤低质量结果

### 知识库集成架构
```
对话管理器 --> 知识库工厂 --> 选择知识库实现
                |                 |
                v                 v
          本地FAISS向量存储     RAGFlow API
                |
                v
          本地医疗数据
```

## 测试结果
### 测试场景1: 中长期记忆调用+紧急情况
```
医疗助手: 您好，我是您的医疗助手。有什么可以帮您？

患者: 医生医生，我心口疼得厉害！我想快点看，我还要赶火车呢！已经难受一天了！

医疗助手: 您好李先生，我注意到您之前有冠心病病史。请问您现在的胸痛是什么感觉？是否和您五年前的心绞痛感觉相似？

患者: 啊？你咋知道我姓李？对对对，就是跟上次那种感觉差不多，但这次更厉害！像是有块石头压着，疼得我喘不过气来！我从乡下赶过来的，还得赶回去照顾我妈，她腿脚不方便！

医疗助手: 请问这种疼痛是持续的还是一阵一阵的？有没有向其他部位扩散，比如左肩、左臂或下巴？

患者: 一阵一阵的，就是我走路上楼梯时特别厉害！好像是有点往左胳膊这边疼...哎呀，我记不清了！都疼得我脑袋糊涂了！医生，我这个严重不严重啊？我还得赶4点那班火车回老家呢！

医疗助手: 您还在服用硝酸甘油和阿司匹林吗？最近有没有停药或者改变用药？

患者: 那个小片我一直吃的，不过前两天药吃完了，这两天没吃。那个...那个啥...硝酸甘油我带着呢，但是我舌头底下含了一片，感觉不太管用！以前含一片就好了，这次含了都还疼！

医疗助手: [系统识别为紧急情况]

就医建议：需要立即就医（症状符合不稳定型心绞痛特征）
建议就诊科室：心内科/急诊科（三级医院）
就医等级：三甲医院（具备冠心病急诊处理能力的医院）
就医前准备：

1. 立即停止活动，就地休息
2. 若随身携带硝酸甘油，可再次舌下含服一片
3. 携带您的病历卡、既往冠心病相关检查资料
4. 请勿独自前往医院，建议呼叫救护车或请人陪同
5. 切勿再乘坐长途火车，需立即处理病情

注意事项：
① 症状分析：
- 您的症状(典型心前区疼痛、向左臂放射、体力活动后加重)与既往心绞痛类似
- 硝酸甘油效果减弱提示病情可能加重
- 近期停药是本次发作的可能诱因
- 目前表现符合不稳定型心绞痛，有演变为心肌梗死的风险

② 即刻处理：
- 避免任何体力活动
- 如疼痛持续或加重，立即拨打120
- 可适当松开衣领，保持呼吸通畅

③ 用药提示：
- 急性发作期可遵医嘱舌下含服硝酸甘油(每5分钟一次，最多连续使用3次)
- 应尽快恢复规律服用您的抗血小板药物
- 切勿自行增减其他心脏药物剂量

患者: 这这这...这么严重啊！我只是想开点药就回去的！那火车票不是白买了吗？我妈还在家等我回去照顾她呢！哎呀，疼死我了，但是我真的得回去啊！

医疗助手: 李先生，您的健康是最重要的。根据您的病史记录和目前症状，您的情况确实需要立即处理，不建议您乘坐长途火车。

关于您的顾虑，我有几点建议：
1. 您可以先联系家人，告知您的情况，看是否有其他亲友可以暂时照顾您母亲
2. 车票问题可以后续解决，许多铁路站点对因病无法乘车的情况有退票政策
3. 您现在的首要任务是接受紧急医疗评估，防止病情恶化

请记住，根据您2018年的冠脉造影结果，您的右冠脉有90%狭窄。现在的症状表明病情可能进一步发展，需要立即处理。如果发生心肌梗死，后果会更严重，也会耽误更长时间。

保持好您的身体健康，才能更好地照顾您的母亲。

患者: 好吧好吧...我这就给我儿子打电话，让他来接我去医院...也只能这样了。那个...我上次住院吃的药你们这边医院能配到吗？我老家那个小医院根本没那些药...

医疗助手: 关于预防心绞痛复发和心血管健康的重要知识：

1. 药物治疗核心要点：
- 抗血小板药物（如阿司匹林）需长期坚持服用，能有效降低血栓形成风险
- 他汀类药物控制血脂，减缓动脉粥样硬化进展
- 硝酸酯类药物缓解急性发作，但不应作为预防唯一手段
- β受体阻滞剂有助降低心脏负荷，减少心绞痛发作

2. 急性发作识别与处理：
- 心绞痛持续超过20分钟且硝酸甘油无效时，应考虑心梗可能
- 出现大汗、恶心、呕吐等伴随症状时警惕度应提高
- 硝酸甘油最多连续使用3次，间隔5分钟，无效应立即就医

3. 生活方式关键调整：
- 控制高血压、糖尿病等基础疾病是冠心病管理核心
- 低盐低脂饮食，保持适度体重
- 避免剧烈运动及情绪激动，可进行缓和有氧活动
- 绝对禁烟，避免被动吸烟

4. 长期随访与监测：
- 冠心病需终身管理，定期心脏超声及心电图检查
- 每6-12个月进行心功能评估及用药调整
- 记录日常症状变化，建立自我监测意识

医院所有常规心血管药物都能提供，包括您上次住院使用的药物。如需长期服药，医生会提供详细处方，您可以在大医院配药后带回老家。如有必要，可申请慢病长处方（最多3个月用量）。

对话结束,感谢您的使用
```
### 测试场景2: 中长期记忆调用+个性化交互 （用户画像：professional + detailed）
```
医疗助手: 您好，我是您的医疗助手。请问您有什么不舒服的地方吗？

患者: 医生，我这两天头晕得厉害，站起来的时候眼前一黑，差点跌倒！

医疗助手: 请问这种头晕症状持续多久了？是持续性的还是间歇性的？

患者: 断断续续有半个月了吧，一开始没当回事，这两天越来越明显。特别是起床或者蹲下站起来的时候，感觉天旋地转的，得扶着东西才行。我是不是得了什么严重的病啊？

医疗助手: 张女士，了解了。除了头晕，您还有其他症状吗？比如头痛、恶心、耳鸣或视力模糊等？

患者: 对，我有时候也会头痛，跟以前的偏头痛差不多，但没那么厉害。最近胃口也不太好，感觉整个人没精神，可能是最近工作太忙了。

医疗助手: 您最近测量过血压吗？如果测量过，大概是多少？

患者: 前天早上量了一次，好像是90/60，平时都是110多/70的样子。医生，我这是血压低了吗？我老公说我可能贫血，但我也不懂，就是觉得越来越不舒服，想看看到底怎么回事。我妈以前也有贫血...

医疗助手: 请问您最近的饮食和饮水情况如何？是否有规律进食和足够的水分摄入？

患者: 饮食很不规律，经常忙得顾不上吃饭，有时候就随便吃点。水喝得也少，尤其是忙起来就忘了。最近天气热，出汗多，可能真的水喝少了...医生，这会影响血压吗？

医疗助手: 您目前正在服用什么药物吗？包括处方药、非处方药或保健品都请告诉我。

患者: 偶尔会吃点奥美拉唑，胃不舒服的时候。最近睡不好，有时候会吃点褪黑素，朋友给的。哦对了，之前您给我开的那个头痛药，我吃了两周就停了，感觉胃不太舒服。

医疗助手: [开始诊断分析] 根据您所描述的症状和医疗信息，您目前主要面临的是体位性低血压的问题，表现为站立时头晕、血压下降(90/60)。这种情况通常与以下因素相关：

1. 脱水：您提到最近天气热、出汗多但饮水少，这可能导致血容量减少
2. 不规律饮食：可能造成电解质失衡和血糖波动
3. 过度疲劳：工作压力大、睡眠不足会影响自主神经调节功能
4. 停用偏头痛药物：某些药物停用后可能出现反跳效应

您既往的偏头痛史和胃炎史也可能与当前症状有一定关联。尤其是，您停用的偏头痛药物可能是影响血压调节的因素之一。低血压虽然通常不如高血压危险，但明显的症状同样需要关注和处理。

患者: 我应该怎么治疗呢？需要吃药吗？我最近真的太忙了，没时间去医院，能不能先吃点什么改善一下？

医疗助手: [开始医疗建议] 基于您的体位性低血压症状和个人情况，我建议采取以下措施：

1. 生活方式调整（首要考虑）：
   • 增加液体摄入：每天至少2000ml水，尤其是起床后和每次站立前饮用200-300ml水
   • 适量增加盐分摄入：除非您有特殊限制，否则适当增加食盐摄入有助于提高血压
   • 改善饮食规律：即使工作繁忙，也应保证定时进食，避免长时间空腹
   • 姿势转换要缓慢：从卧位或蹲位起身时分阶段完成，先坐一会再站起

2. 短期应对措施：
   • 出现头晕症状时立即坐下或平躺，抬高双腿
   • 可穿着弹力袜或弹力裤，帮助下肢血液回流
   • 避免长时间站立不动，若需久站应适当活动双腿
   • 睡觉时适当抬高床头10-20厘米

3. 药物考虑：
   • 目前不建议立即药物干预，先观察生活方式调整效果
   • 对于您既往的偏头痛，可考虑咨询医生更换对胃部刺激较小的预防用药
   • 避免同时使用多种自行购买的药物或保健品

4. 监测建议：
   • 每日测量血压，记录早晚各一次，特别是出现症状时额外测量
   • 如果症状持续超过两周未改善，或者出现新的严重症状，如突然剧烈头痛、持续性恶心呕吐、意识不清等，应立即就医
   • 定期随访，评估症状变化

根据您对专业详细信息的偏好，我额外补充以下医学机制解释：体位性低血压主要与血管自主神经调节功能障碍有关，当人体从卧位或坐位转为站立位时，重力使约500-700ml血液滞留于下肢，正常情况下交感神经会立即代偿性收缩外周血管并增加心率，但当这一机制受损或反应不足时，就会出现暂时性脑灌注不足，导致头晕、视物模糊等症状。

患者: 明白了，我会增加喝水量，注意饮食。请问我平时喝咖啡会不会影响血压？我工作压力大，常喝咖啡提神。

医疗助手: [开始健康教育] 关于体位性低血压和日常健康管理，以下信息对您可能有帮助：

1. 咖啡因与血压的关系：
   • 咖啡因短期内可轻度升高血压，但对体位性低血压患者，适量咖啡实际可能有益
   • 建议：每日咖啡摄入控制在1-2杯，最好在上午饮用，避免下午4点后饮用影响睡眠
   • 注意：不要空腹饮用咖啡，可能加重胃部不适（考虑到您的胃炎史）

2. 工作压力管理对血压的影响：
   • 长期压力会影响自主神经系统功能，可能加重体位性低血压
   • 建议工作间隙采用"微休息"策略：每工作45-60分钟，休息5-10分钟
   • 尝试呼吸放松法：每天2-3次，每次5分钟的深呼吸练习
   • 可考虑渐进性肌肉放松训练，帮助缓解压力

3. 偏头痛与低血压的关联性：
   • 研究显示偏头痛患者自主神经功能常有异常，可能同时影响血压调节
   • 注意记录头痛发作与低血压症状的时间关系，有助于医生评估
   • 偏头痛发作前若出现视力变化、头晕等先兆，应立即休息

4. 营养补充建议：
   • 维生素B族：有助于神经系统功能，但建议从天然食物获取，如全谷物、绿叶蔬菜
   • 铁质：考虑到您家族史中有贫血，可适当增加瘦肉、豆类等含铁食物
   • 电解质平衡：补充适量钾、镁、钙（香蕉、坚果、奶制品）
   • 酌情补充复合维生素，但应避免过量

5. 自我监测指导：
   • 学习正确测量血压方法：安静休息5分钟后测量，位置一致
   • 使用"症状日记"记录头晕、头痛发作的时间、强度及相关因素
   • 注意识别恶化信号：如头晕频率明显增加、出现新的神经系统症状

综合考虑您的专业背景和详细信息偏好，上述建议旨在提供全面的健康管理策略。如果按此执行两周后症状无改善，建议预约神经内科专科医生进行详细评估。

患者: 谢谢医生，这些建议非常有用。我会按照您说的去做，特别是增加水分摄入和规律饮食。如果症状持续或恶化，我会及时就医。

医疗助手: 张女士，不客气。很高兴能够帮助您。我已经为您记录了这次的症状和建议，便于下次随访参考。

请记住，调整生活习惯需要时间见效，建议您坚持至少两周。特别关注您在工作压力大的情况下，多注意休息和水分补充。考虑到您既往的偏头痛史，如果头痛症状加重，我们可能需要重新评估预防性用药方案。

祝您健康，如有任何变化或疑问，随时咨询。

对话结束,感谢您的使用
```
### 测试场景3: 中长期记忆调用+个性化交互 （用户画像：friendly + simply）
```
医疗助手: 您好，我是您的医疗助手。请问您有什么不舒服的地方吗？

患者: 哎呀，医生啊，我这两天腿疼得厉害，走路都不利索了。特别是右腿，膝盖这里，疼得我呀，上下楼都困难。

医疗助手: 您好王老师，了解您右膝关节疼痛的情况。这种疼痛大概持续多久了？是突然开始的，还是慢慢加重的呢？

患者: 这腿啊，断断续续疼了有大半年了，以前就是偶尔疼一下，没太在意。这两周突然厉害了，特别是前天下雨，疼得我晚上都睡不好觉。

医疗助手: 能理解这种疼痛确实很影响日常生活和休息。除了疼痛，您的膝盖有没有出现红肿、发热或活动受限的情况呢？

患者: 肿是有点肿，摸着比另一边膝盖粗。不过不红，也不热。就是弯曲不太利索，蹲下特别费劲，起来的时候得扶着东西。医生，我这是不是关节炎啊？我老伴也有这病，她说可能是岁数大了，正常的。

医疗助手: 您平时有没有做什么动作或活动会加重疼痛？比如爬楼梯、蹲下或走路久了？另外，休息后疼痛会有所缓解吗？

患者: 上下楼梯最明显，特别是下楼，每一步都疼。走路久了也疼，站着时间长也受不了。休息一会儿会好一些，但只要一动又疼。前两天孙子来，我抱了他一下，差点没站住，吓死我了。对了，我这个膝盖30多年前打篮球扭伤过，不知道跟那有没有关系。

医疗助手: 您现在有服用什么药物来缓解疼痛吗？另外，您每天服用降压药和降糖药吗？

患者: 就买了点膏药贴上，感觉没啥用。前两天实在受不了，吃了两片布洛芬，好像稍微舒服点。那个降压药和降糖药每天都按时吃的，早上一次，晚上一次，从来不耽误。医生，这个膝盖疼会不会影响我的血压啊？最近量了好像比平时稍微高一点。

医疗助手: [开始诊断分析]
王老师，从您描述的情况来看，您很可能是患了膝关节骨关节炎，这是一种常见的关节退行性疾病。

您的症状非常典型：
- 膝关节疼痛，特别是下楼梯和久站时加重
- 关节肿胀但不发热发红
- 活动受限，尤其是蹲起困难
- 休息后症状有所缓解
- 天气变化(下雨天)时症状加重

您30多年前的膝关节扭伤确实可能是促发因素之一，老年人、过度使用关节和既往关节损伤都是骨关节炎的常见危险因素。

至于您提到的血压略高，这可能与疼痛有一定关系。持续的疼痛会导致压力增加，进而影响血压，所以控制关节疼痛对您的整体健康也很重要。

患者: 唉，老了老了，这毛病越来越多了。那医生，这关节炎能治好吗？需要吃什么药？我听说有人打针，效果挺好，我需要打针吗？

医疗助手: [开始医疗建议]
王老师，别担心，膝关节骨关节炎虽然不能完全治愈，但我们有很多方法可以缓解症状，帮您维持正常生活质量。

简单实用的建议：

1. 药物治疗：
   • 可以使用布洛芬等非处方止痛药缓解疼痛，但不要长期大量使用
   • 考虑到您有高血压，用药需要谨慎，最好遵医嘱短期使用
   • 外用药膏如消炎止痛膏、酸辣膏等可能有一定帮助，使用更安全

2. 非药物方法：
   • 冷敷热敷：急性疼痛时冷敷(20分钟)，慢性疼痛时热敷
   • 适当休息：疼痛加重时减少膝关节负重
   • 辅助工具：考虑使用拐杖减轻膝关节负担
   • 保持理想体重：减轻体重对关节的压力

3. 物理治疗：
   • 简单的膝关节周围肌肉锻炼，增强支撑力
   • 可以尝试温水泡脚，减轻关节僵硬

关于关节注射：确实有关节腔注射治疗(如玻璃酸钠)，但这需要专科医生评估后决定是否适合您，不建议作为首选治疗。

需要提醒您继续按时服用降压药和降糖药，这对控制基础疾病和保护关节都很重要。

患者: 我明白了，先试试药膏和热敷，疼厉害了再吃点止痛药。那个，医生，我这个关节还能锻炼吗？我平时喜欢早上去公园散步，这个还能继续吗？

医疗助手: [开始健康教育]
王老师，您喜欢散步是很好的习惯，建议继续保持！以下是一些关于膝关节炎的小贴士：

关于锻炼：
- 散步很适合您！它是低冲击运动，有助于保持关节灵活性
- 建议穿舒适的减震鞋，在平坦路面上走
- 开始时间短一些(比如15分钟)，慢慢增加到30分钟
- 如果走路时疼痛加重，可以休息一天再继续

日常生活小窍门：
- 避免长时间站立和蹲位
- 上下楼梯时可以"好腿先上，坏腿先下"
- 坐时选择较高的椅子，避免深蹲起坐
- 抱孙子时请坐着抱，避免站立负重

饮食建议：
- 多吃富含抗氧化物的蔬果(彩色蔬菜、水果)
- 适量补充钙质(豆制品、奶制品)
- 减少高盐高脂食物，有助于控制体重和血压

需要就医的情况：
- 如果膝关节突然严重疼痛或肿胀
- 出现发热、发红或无法承重
- 疼痛持续加重且不能缓解

记住，适度活动比完全不动更有利于关节健康。保持乐观心态也很重要，很多人通过适当管理能和关节炎和平共处很多年！

患者: 好的，我都记住了。谢谢医生，我会按照您说的做，先试试这些方法，如果还是不行再来医院。对了，这个膏药能在药店直接买吗？

医疗助手: 是的，王老师，止痛消炎膏在普通药店就能买到，不需要处方。您可以咨询药店工作人员推荐适合关节疼痛的外用药膏。

很高兴能帮到您！记得保持适当活动，别因为怕疼就完全不动。如果这些方法使用两周后疼痛没有改善，或者症状加重，建议您来医院骨科门诊进一步检查。

祝您健康，有任何不适随时来咨询！

对话结束,感谢您的使用
```
### 测试场景4: 信息矛盾识别 
```
医疗助手: 您好，我是您的医疗助手。请问您有什么不舒服的地方吗？

患者: 医生我最近老是头晕，有时候还会心慌，睡不好觉，感觉身体被掏空，没劲，我是不是得什么大病了啊？

医疗助手: 您好，我理解您的担忧。头晕、心慌、睡眠问题和乏力可能由多种原因引起。为了更好地了解您的情况，请问这些症状大约持续了多长时间？是突然出现的还是逐渐发展的？

患者: 也不知道多久了，反正最近特别明显，可能有两三个月了吧，刚开始还没在意，以为就是累了，但现在越来越严重了，特别是站起来的时候，感觉眼前一黑，头特别晕，都怕自己摔倒

医疗助手: 了解了，症状已持续两三个月且逐渐加重，尤其是体位变化时头晕加重。请问您能再详细描述一下心慌的感觉吗？比如何时出现，持续多久，是否感觉心跳加快或不规律？另外，您的年龄和性别是？

患者: 我今年40多岁吧，哦对，42，女的。心慌就是觉得心脏砰砰跳，有时候晚上躺着也能感觉到，好像心跳特别快，特别是紧张的时候更明显。不过也不是天天都这样，断断续续的

医疗助手: 谢谢您提供的信息。为了更全面地了解您的情况，请问您有没有测量过血压或心率？是否有高血压、糖尿病、甲状腺疾病等慢性病史？或者家族中有类似疾病史？另外，您平时的作息、饮食和工作压力情况如何？

患者: 我没测过血压，家里没血压计。我妈有高血压，我自己没查出来什么病。平时工作挺忙的，经常加班到很晚，周末也常常要处理工作，饮食不太规律，早饭经常没时间吃，中午随便吃点，晚上回家太晚了有时候就点外卖。哦对了，我喜欢喝咖啡，一天可能三四杯，不然没精神工作

医疗助手: 感谢您的详细描述。您提到家族有高血压史，同时工作压力大、作息不规律、饮食不规律，且咖啡摄入量较高。这些都可能与您的症状有关。

请再告诉我几个问题：您是否有贫血史？最近有没有明显的体重变化？平时有运动习惯吗？另外，请问您有没有服用任何药物，包括处方药或非处方药？

患者: 我之前检查说有点轻微贫血，但医生说问题不大。体重的话，可能最近瘦了点，衣服有点松了，但没专门称过。运动基本没时间，以前偶尔周末去公园走走，现在都没空。药的话，就吃点维生素和钙片，有时候头疼会吃布洛芬，对了，我有时失眠会吃点褪黑素，但效果一般

医疗助手: 非常感谢您提供的全面信息。现在我对您的情况有了更清晰的了解。您提到有轻微贫血史，最近体重可能有所下降，几乎没有运动习惯，并且偶尔服用褪黑素和布洛芬。再问一个重要问题：您在头晕、心慌发作时，有没有出现胸闷、胸痛、呼吸困难、出汗、恶心等其他症状？另外，您的睡眠问题具体表现为难以入睡，还是容易醒来，或者睡眠质量差？

患者: 我之前说错了，我觉得我可能没有贫血，因为我记得医生看了我的检查报告说一切正常。头晕的时候有时候会出汗，感觉心跳加速，但没有胸痛。睡眠的话主要是睡不着，躺在床上翻来覆去的，经常到凌晨一两点才能睡着，而且睡着了也容易醒，做梦特别多

医疗助手: 我注意到您对贫血情况的描述有所调整，这很重要，谢谢您的澄清。根据您提供的信息，我们需要关注几个方面：

1. 您的症状（头晕、心慌、出汗、睡眠问题）
2. 家族高血压史
3. 高强度工作、不规律作息和饮食
4. 高咖啡因摄入
5. 可能的体重下降
6. 缺乏运动

您描述的症状组合可能与多种因素有关，包括：

1. 压力相关问题（如焦虑、慢性压力）
2. 自主神经功能紊乱
3. 血压波动（尤其是直立性低血压）
4. 咖啡因过量导致的影响
5. 可能的内分泌问题

建议您进行以下检查：
1. 全面体检，包括血常规、血压监测
2. 心电图和心脏功能评估
3. 甲状腺功能检查
4. 血糖和电解质水平

患者: 您说的这些可能性听起来很吓人，我是不是病得很严重啊？需要马上去医院吗？

医疗助手: 请不要过于担心。根据您描述的症状和情况，虽然确实需要关注，但这些症状很可能与生活方式因素有关，如工作压力大、作息不规律、咖啡因摄入过多等。大多数情况下，通过调整生活方式和适当的医疗干预，这些症状是可以改善的。

关于就医建议：
- 建议您在近期（1-2周内）安排一次门诊就诊，不需要紧急就医
- 建议科室：内科或全科医学科
- 就医前可先监测几天的血压数据（可考虑购买家用血压计）

在就医前，您可以尝试以下调整：
1. 减少咖啡因摄入，尤其是下午后不饮用咖啡
2. 规律作息，尝试制定固定的睡眠时间表
3. 改善饮食规律性，确保不空腹
4. 尝试简单的减压技巧，如深呼吸或轻度伸展运动
5. 体位变化时（如从坐到站）动作放慢，给身体适应的时间

这些症状虽然影响生活质量，但通常不表示严重疾病。重要的是找出具体原因并针对性处理。

患者: 好的，谢谢医生。我再问一下，我这种情况还能喝咖啡吗？实在不喝感觉工作没精神啊

医疗助手: [开始医疗建议] 关于咖啡摄入的建议：

考虑到您的症状和工作需求，我建议采取以下咖啡摄入策略：

1. 咖啡总量控制：
   - 将每日咖啡量逐渐减少至1-2杯（每杯约240ml）
   - 减少过程应渐进，例如第一周每天减少半杯，避免突然戒断引起头痛

2. 咖啡饮用时间调整：
   - 最后一杯咖啡应在下午2点前饮用
   - 早上第一杯咖啡最好在早餐后饮用，避免空腹
   - 两杯咖啡之间至少间隔3-4小时

3. 咖啡替代方案：
   - 下午可改用低咖啡因绿茶（含咖啡因约为咖啡的1/3）
   - 考虑部分咖啡替换为脱因咖啡
   - 尝试其他提神但咖啡因含量较低的饮品，如玛黛茶

4. 提高工作精神的替代方法：
   - 工作间隙进行5分钟快走或楼梯运动
   - 办公室准备一瓶柠檬水或薄荷水，频繁小口饮用
   - 每工作45-60分钟，进行3-5分钟的伸展活动或深呼吸

请记住，突然完全停止咖啡摄入可能导致戒断症状（如头痛、烦躁），因此逐渐调整是更可取的方法。

患者: 明白了，我会尝试慢慢减少咖啡摄入量，谢谢医生的建议。最后问一下，我做什么运动比较合适？平时没什么时间

医疗助手: [健康教育] 适合您工作繁忙情况的运动建议：

考虑到您的时间限制和当前症状，我推荐以下高效、低门槛的运动方案：

1. 碎片化运动策略（融入日常生活）：
   - "通勤运动"：提前一站下车步行、选择爬楼梯而非电梯
   - "办公室微运动"：每小时起身活动3分钟，做简单伸展或原地踏步
   - "居家3分钟"：晨起和睡前各3分钟的伸展运动

2. 周末集中式运动（30-45分钟/次）：
   - 快走（最适合初始阶段）：选择公园或小区步道
   - 游泳（如有条件）：全身性低冲击有氧运动
   - 瑜伽：特别推荐缓解压力的恢复性瑜伽

3. 循序渐进原则：
   - 第1-2周：日常碎片化运动+周末一次30分钟快走
   - 第3-4周：增加工作日午休后5-10分钟快走
   - 第5周起：可考虑加入强度略高的活动（如慢跑、HIIT）

4. 智能监测与激励：
   - 使用手机计步器设定每日目标（初始6000步，逐渐增加）
   - 尝试"运动日历"记录法，持续打卡形成习惯

要点提示：
- 任何运动都比不运动好，哪怕只有5分钟
- 头晕发作时应立即停止运动并坐下休息
- 运动后密切观察症状变化，作为医生诊断的重要参考

记住，对于您的情况，运动的首要目标是改善自主神经功能和减轻压力，而非体能训练。即使是最简单的定期活动也能带来显著益处。

患者: 谢谢医生的详细建议！我会尝试这些方法，改善我的生活方式

医疗助手: 很高兴能够帮到您！您的积极态度是健康改善的重要一步。记住，生活方式的调整是一个渐进过程，不必一次性完成所有改变。可以从最容易实施的建议开始，逐步纳入其他调整。

建议您记录症状变化和生活方式调整的关联，这将有助于您的医生更精确地诊断和治疗。如果症状加重或出现新的不适，请及时就医。

祝您健康改善，工作顺利！如有任何后续问题，欢迎随时咨询。

对话结束,感谢您的使用
```

### 测试场景5: 初次标准完整问诊流程（信息收集、症状分析、医疗建议、健康教育）
```
医疗助手: 您好，我是您的医疗助手。请问您有什么不舒服的地方吗？
患者: 我这两天胃不太舒服
医疗助手: 除了胃不舒服，您还有其他伴随的症状吗？比如恶心、呕吐或者腹泻？
患者: 没什么特别的，就是这两天感觉有点累，可能是因为胃不舒服，晚上睡眠也不是很好。偶尔会觉得有点反酸，但不是很明显。
医疗助手: 请问您的年龄是多少？
患者: 我今年35了，马上要36了，属猪的。
医疗助手: 您的胃部不适是持续性的还是间歇性的？有没有伴随烧心或反酸的感觉？
患者: 嗯，不是一直都疼，主要是吃完饭后会难受一会儿，饿的时候反而好一些。有时候晚上睡觉前也会有点不舒服。
医疗助手: 请问您的性别是？
患者: 女的，我是女的。
医疗助手: 请问您目前正在服用哪些药物或补充剂？
患者: 最近没吃什么药，就前两天胃疼了，自己去药店买了点胃舒平，吃了一天。
医疗助手: 请问您过去是否有过胃溃疡、胃炎或其他消化系统疾病的病史呢？
患者: 我啊，之前身体还不错，没有什么大病，就是有点轻微的甲状腺问题，医生说是亚健康，也没怎么吃药。哦对了，十年前做过一个阑尾炎手术，不是很大的手术。
医疗助手: 请问您是否有药物或食物过敏史？
患者: 青霉素过敏，吃了会起疹子，挺难受的。还有海鲜不能吃太多，吃多了也容易过敏。
医疗助手: 您能具体描述一下胃不舒服的感觉吗？比如是隐痛、灼烧感还是胀闷感？
患者: 就是这里，胃这个位置，吃东西的时候有点隐隐作痛，不是很剧烈，但挺不舒服的，有时候还会胀胀的。
医疗助手: 您最近的饮食规律吗？比如有没有经常吃辛辣、油腻的食物，或者经常外出就餐？
患者: 说实话，我饮食不太规律，工作忙起来经常忘记吃饭，有时候中午就随便吃个快餐，晚上回家太晚了，也懒得做饭，就点个外卖，经常吃些烧烤啊火锅啊这些。平时也爱喝咖啡，提提神。
医疗助手: 您平时有吸烟或饮酒的习惯吗？如果有的话，大概的频率是怎样的呢？
患者: 我不抽烟，但偶尔会喝点酒，特别是和客户应酬的时候，一周可能有一两次吧，不过不会喝很多。
医疗助手: 您最近的睡眠情况怎么样？比如每天睡几个小时，有没有入睡困难或者多梦的情况？
患者: 最近睡得不太好，工作比较忙，通常半夜12点多才睡，早上7点就得起，大概六个小时吧。有时候半夜会醒一下，可能是胃不舒服的原因。
医疗助手: 您平时有没有规律运动的习惯？比如每周会做些跑步、游泳之类的锻炼吗？
患者: 平时挺少运动的，主要是没什么时间。偶尔周末会去公园走走，但是很不规律，最近一个月好像都没怎么运动了。
医疗助手: [开始诊断分析] 症状详细分析 患者以餐后胃部不适为主诉，症状在进食后加重、空腹时缓解，且夜间睡前加重，符合消化性溃疡（尤其是十二指肠溃疡）的典型疼痛节律。结合以下特点：...
患者: 继续
医疗助手: [开始医疗建议] 用药注意事项和药物相互作用 - 胃舒平（铝碳酸镁）需餐后1-2小时或睡前嚼服，避免与以下药物同服：...
患者: 继续
医疗助手: [开始健康教育] 一、预防和保健建议 1. 饮食调整：规律进食：每日定时定量进餐，避免过饥过饱，可采用"少量多餐"（每餐5-7分饱，每日4-5餐）...
患者: 继续
医疗助手: [给出最终建议] 根据您描述的餐后胃胀、食欲下降、口气重等症状，结合医学知识库信息为您整理以下指导建议：【日常调养指南】 1. 饮食可尝试"三三原则"：每餐吃三成饱，每日分三次加餐（如上午10点、下午3点、睡前1小时）...

对话结束,感谢您的使用
```

### 测试场景6:紧急情况测试 （收集症状阶段识别紧急情况，直接进入转诊建议）
```
医疗助手: 您好，我是您的医疗助手。请问您有什么不舒服的地方吗？

患者: 我朋友倒地抽搐，口吐白沫

医疗助手: [系统识别为紧急情况]

就医建议：非紧急但需及时就诊（症状严重程度较高，建议3天内就医）
建议就诊科室：神经内科（三级医院）或癫痫专科门诊
就医等级：三级医院（可进行视频脑电图监测、核磁共振等精密检查）
就医前准备：


记录发作具体细节：发作时长、诱发因素、发作频率
准备手机拍摄发作视频（如有条件）
携带既往就诊资料及正在服用的药物清单
穿着宽松衣物便于检查
有家属陪同就诊


注意事项：
① 发作防护：


避免从事驾驶、高空作业、游泳等高风险活动
发作时保持侧卧位防止误吸
移除周围尖锐物品保护头部
记录每次发作的具体时间及表现

② 生活管理：

保证7-8小时规律睡眠
避免咖啡因、酒精及闪光刺激
控制手机/电脑使用时间（每天不超过4小时）
维持稳定情绪，避免过度疲劳

③ 诊疗配合：

即使未再发作也要按医嘱复查（每3-6个月）
检查前需保持头皮清洁（脑电图检查要求）
可能需要72小时动态脑电图监测
治疗药物需严格遵医嘱调整剂量

建议：70%的癫痫患者通过规范治疗可实现无发作，建议尽早就诊三级医院神经内科。目前国际指南推荐的新型抗癫痫药物有效率可达85%，切勿因既往治疗效果欠佳而放弃治疗。

患者: 继续

医疗助手: 关于癫痫的预防、保健及日常管理，请您注意以下信息：

预防与保健建议：


保持规律作息，避免熬夜或过度疲劳
饮食均衡，限制咖啡、浓茶、酒精等刺激性饮品
保持情绪稳定，避免强烈精神刺激
预防头部外伤（如骑车戴头盔）
严格遵医嘱用药，不可自行增减药量或停药


需要警惕的紧急情况：
❗若出现以下情况请立即就医：


单次发作持续超过5分钟
短时间内多次发作(发作间歇期意识未恢复)
发作后出现呼吸困难/发绀
发作期间造成严重外伤


日常自我监测要点：


记录发作日志：日期、持续时间、发作表现
观察发作前是否有预兆(如特殊气味、闪光感)
注意药物副作用：定期复查肝肾功能
监测体温变化(发热可能诱发发作)


重要健康知识：


约70%患者通过规范用药可控制发作
突然停药是诱发癫痫持续状态最常见原因
女性患者备孕前需与医生沟通调整用药
驾驶、游泳等高风险活动需严格遵医嘱

建议每3-6个月到神经内科复诊，通过脑电图和血药浓度检测评估治疗效果。家属应学习发作时的正确处理方法：保持呼吸道通畅、移开危险物品、记录发作表现，切勿强行按压肢体或塞物品入口。

对话结束,感谢您的使用
```

### 测试场景7: 超时测试
```
医疗助手： 您好,我是您的医疗助手。有什么可以帮您？
患者: 你好
医疗助手: 对话时间已超时,建议重新开始咨询。

对话结束,感谢您的使用
```

## 未来优化方向
功能拓展: 添加语音交互功能 支持图片识别功能
