# 医疗问答大模型系统1.0
1.0版本基于LLM的医疗问答系统，集成知识库检索增强生成(RAG)功能
## 功能特点
- 多轮对话支持
- 意图识别和处理
- 知识库检索增强
- SOP流程管理 (目前搁置)
- 不同科室问题处理
## 1.0 系统结构
    medical_LLM_system/
    ├── src/
    │   ├── qa_system.py      # 主系统逻辑
    │   ├── knowledge_base.py # 知识库管理
    │   ├── prompts.py        # 提示词配置
    │   ├── sop_flows.py      # SOP流程配置
    │   ├── llm_api.py        # LLM接口
    │   └── rag/
    │       └── faiss_store.py # 向量存储
    ├── data/
    │   ├── knowledge_base/    # 医疗知识源数据
    │   └── vector_store/      # 向量数据
    ├── test/                 # 测试

## 系统运行逻辑
### 1. 知识库初始化
系统启动时通过init_knowledge_base()函数初始化知识库:

若存在已保存的向量索引,直接加载，否则从CSV文件构建新的向量索引并保存

### 2. 问答处理流程
系统核心问答处理由pipeline()函数实现,主要步骤:

#### 查询改写
- 基于上下文历史对当前查询进行改写优化
- 使用prompt模板结合LLM实现改写

#### 意图识别

- 对改写后的查询进行医疗意图识别，支持常见医疗咨询、疾病预防等意图，非医疗问题归类为闲聊

#### 信息补全判断

- 根据意图类型判断是否需要补充信息
- 对信息不完整的查询生成反问
- 信息完整则继续处理

#### 回复生成

- 闲聊模式:直接基于对话历史生成回复
- 专业问答模式:
  - 检索知识库获取相关文档
  - 结合检索结果和对话历史生成专业回复
- 按照对应意图的SOP流程组织回复内容

## 安装依赖
    pip install -r requirements.txt
主要依赖：
- faiss-cpu #向量数据存储
- sentence-transformers #embedding模型
- langchain #利用其中chunking模型
- pandas
## 使用方法
    from qa_system import pipeline, init_knowledge_base
    
    # 初始化知识库
    init_knowledge_base(
        csv_path='data/knowledge_base/***.csv',
        index_path='data/vector_store/***.index'
    )
    
    # 问答示例
    messages = [
        {"role": "user", "content": "高血压有什么症状？"}
    ]
    response = pipeline(messages)
## 1.0 数据集
开源中文QA问答数据集 （https://github.com/Toyhom/Chinese-medical-dialogue-data/tree/master）

1.0 阶段只选用***内科sample 7644条 QA问答***

数据格式

| department	      | title |  question   |   answer  |
| ----------- | ----------- |-----|-----|
| 心血管科	      | 高血压患者能吃党参吗？	       |   我有高血压这两天女婿来的时候给我拿了些党参泡水喝，您好高血压可以吃党参吗？	  |  高血压病人可以口服党参的。党参有降血脂，降血压的作用，可以彻底消除血液中的垃圾，从而对冠心病以及心血管疾病的患者都有一定的稳定预防工作作用，因此平时口服党参能远离三高的危害。另外党参除了益气养血，降低中枢神经作用，调整消化系统功能，健脾补肺的功能。感谢您的进行咨询，期望我的解释对你有所帮助。|

## 测试结果
### 闲聊测试

    messages = [
            {"role": "user", "content": "今天天气真好"}
        ]
测试输出

    rewritten_query： 这个查询已经比较通顺和精确地表达了一种关于今天天气状况的描述性信息。如果从信息需求角度进一步优化，可改为：“查询今天的天气状况，结果显示天气很好”  。这样更明确地
    原始意图： 其他
    intent:  闲聊
    最终生成回答： 是呀，这么好的天气可别辜负啦！很适合出去走走，享受一下阳光呢。你有没有打算出门逛逛呀？

### 完整问题测试 （不需要通过反问补全问题）

    messages = [
            {"role": "user", "content": "我想知道如何预防心脏病？我没有家族病史，但是有高血压"}
        ]
测试输出

    rewritten_query： 我没有心脏病家族病史，但患有高血压，想了解一下该如何预防心脏病？ 
    原始意图： 疾病预防
    intent:  疾病预防
    原始的completed_query:  None
    completed_query:  我没有心脏病家族病史，但患有高血压，想了解一下该如何预防心脏病？  False
    检索到的相关知识： 科室：心血管科 主题：如何能够预防高血压？ 问：医生，我小叔叔今年54岁了，最近对身体的情况有点担心，因为旁边有一些同龄人都得了高血压，他就很担心自己的情况，所以想问问医生如何预防工作高血压？ 答：在饮食方面上要注意多吃清淡类食物，可以多吃蛋白质类丰富的食物，维生素也要消化好，蔬菜水果要多吃；要依稀记得多喝水，水是生命中最重要的一种无机物，充当个特别重要的角色，可以调整体内浓度，也可以溶化一些物质，每天至少要消化八大杯水；除此之外还要依稀记得要坚持锻炼身体，身体是反帝的本钱，多加锻练能增加身体的免疫力，可以做一些有氧运动，比如说跑步，散步，打打太极，等比较缓慢的活动；还需要有多和家人聊天交流始终保持心情舒畅愉悦，切勿动气。
    科室：心血管科 主题：轻度高血压该怎么处理好呢？ 问：最近总是头晕、头疼、视力模糊、气血不足、上不来气、四肢乏力、神经衰弱、夜尿增多、胸闷、干呕、有时会肢体麻木，想进行咨询一下医生，轻度高血压怎么治疗才好呢？ 答：轻度高血压，首先是需要有规律的口服降压药物来控制血压，可以决定血管紧张素切换酶抑制剂来实施治疗。另外生活中需要有注意低盐低脂饮食，防止熬夜，始终保持心情的愉悦，防止焦虑，抑郁，紧张，防止抽烟，饮酒等这些升高血压的因素。而头晕，头痛，肢体麻木等情况，可以进一步的做颅脑ct仔细检查，排除脑血管疾病的可能会。
    科室：心血管科 主题：高血压血压特高怎么降压 问：我是家族遗传性的高血压，我家里人平常正常的时候血压都有一百六一百七，然后我今天觉着头有点晕，自己量了一下到了260，您好我高血压血压特高怎么救治？一般的降压药好象都对我没效果。 答：您好，高血压是需要有吃降压药控制，特别高并且有点晕的话建议口服一次降压药并且立即在家人的带领下到就近的医院复诊，系统仔细检查并确认治疗方案来控制血压。一般降压药对你没什么效果的话需要有专业医生筛查后给您确认药物来降血压，期望您尽快复诊医院系统治疗，平时低盐低脂饮食，祝您早日康复。
    最终生成回答： 了解到您有高血压，这是一个需要重点关注的因素。以下是基于您的情况给出的预防心脏病的建议：
    ### 预防建议
     - **饮食方面**：继续坚持低盐低脂饮食，因为高盐高脂饮食会加重血管负担，不利于血压控制，也会增加心脏负担。多吃清淡类食物，保证蛋白质、维生素的充足摄入，多吃蔬菜水果，每天保证充足水分摄入，至少八杯水。
     - **运动方面**

### 不完整问题测试

    messages = [
                {"role": "user", "content": "我最近咳嗽得厉害"}
            ]
测试输出

    rewritten_query： 我最近咳嗽的症状非常严重
    原始意图： 医疗咨询
    intent:  医疗咨询
    原始的completed_query:  请问你咳嗽的症状持续了多久？还有其他症状吗？
    completed_query:  请问你咳嗽的症状持续了多久？还有其他症状吗？ True
    最终生成回答： 请问你咳嗽的症状持续了多久？还有其他症状吗？

### 多轮问答测试

    messages = [
            {"role": "user", "content": "我经常失眠"},
            {"role": "assistant", "content": "请问您失眠的具体表现是什么？入睡困难还是容易醒？"},
            {"role": "user", "content": "主要是睡不着，每天要躺床上2小时才能入睡"}
        ]
测试输出

    rewritten_query： 主要的失眠表现是入睡困难，每天躺在床上要2小时才能睡着 
    原始意图： 医疗咨询
    intent:  医疗咨询
    原始的completed_query:  请问这种入睡困难的情况持续多久了？是否还有其他伴随症状？
    completed_query:  请问这种入睡困难的情况持续多久了？是否还有其他伴随症状？ True
    最终生成回答： 请问这种入睡困难的情况持续多久了？是否还有其他伴随症状？

### 知识库检测异常测试

    messages = [
                {"role": "user", "content": "治疗肥胖症胃绕道手术步骤，无其他基础疾病以及过敏，年龄29， 性别男， BMI45，术前正常"}
            ]
测试输出

    rewritten_query： 29岁无其他基础疾病及过敏史的男性，BMI为45且术前身体状况正常，求治疗肥胖症的胃绕道手术具体步骤 
    原始意图： 医疗咨询
    intent:  医疗咨询
    原始的completed_query:  None
    completed_query:  29岁无其他基础疾病及过敏史的男性，BMI为45且术前身体状况正常，求治疗肥胖症的胃绕道手术具体步骤  False
    知识库检索错误: Knowledge base error
    最终生成回答： ### 初步诊断
    根据你提供的信息，目前考虑你因BMI达到45 ，符合肥胖症的诊断标准，且有通过胃绕道手术治疗肥胖症的需求。
    ###建议
    胃绕道手术是一种较为复杂的减肥手术，虽然能有效减轻体重，但也存在一定风险。在决定进行手术前，首先建议你尝试通过生活方式干预来减重，包括严格控制饮食（减少高热量、高脂肪、高糖食物摄入，增加